AppSync={serverUrl:null,db:null,tablesToSync:[],syncInfo:null,syncResult:null,lastSyncDate:0,firstSync:!1,cbEndSync:null,Find:function(n,t,e,s,a){var c="model"+n.getId();AppDB.transaction(function(n){n.executeSql("SELECT * FROM "+t+" WHERE "+e+" "+s+" ?",[a],function(n,t){for(var e=new Array,s=0;s<t.rows.length;s++)e.push(t.rows.item(s));window[c].setData(e)},null),window[c].refresh()})},initSync:function(n,t,e,s,a){var c=this,r=0;for(this.db=t,this.serverUrl=s,this.tablesToSync=n,this.syncInfo=e,r=0;r<c.tablesToSync.length;r++)"undefined"==typeof c.tablesToSync[r].idName&&(c.tablesToSync[r].idName="id");c.db.transaction(function(n){c._executeSql("CREATE TABLE IF NOT EXISTS sync_info (last_sync TIMESTAMP);",[],n)}),c._selectSql("SELECT last_sync FROM sync_info",null,function(n){0===n.length||0==n[0]?(c._executeSql("INSERT OR REPLACE INTO sync_info (last_sync) VALUES (0)",[]),c.firstSync=!0,c.lastSyncDate=0,c.syncInfo.lastSyncDate=c.lastSyncDate,a(!0)):(c.lastSyncDate=n[0].last_sync,0===c.lastSyncDate&&(c.firstSync=!0),c.syncInfo.lastSyncDate=c.lastSyncDate,a(!1))})},syncNow:function(n,t){var e=this;if(null===this.db)throw"You should call the initSync before (db is null)";e.syncResult={syncOK:!1,codeStr:"noSync",message:"No Sync yet",nbSent:0,nbUpdated:0},e.cbEndSync=function(){n(e.syncResult.message,100,e.syncResult.codeStr),t(e.syncResult)},e._getDataToBackup(function(n){e._sendDataToServer(n,function(n){e._updateLocalDb(n,function(){e.syncResult.localDataUpdated=e.syncResult.nbUpdated>0,e.syncResult.syncOK=!0,e.syncResult.codeStr="syncOk",e.syncResult.message="Data synchronized successfuly. ("+e.syncResult.nbUpdated+" updated)",e.cbEndSync(e.syncResult)})})})},log:function(){},error:function(n){console.error(n)},resetSyncDate:function(){this.syncInfo.lastSyncDate=0,this.firstSync=!0,this._executeSql('UPDATE sync_info SET last_sync = "0"',[])},_getDataToBackup:function(n){var t=this;t.log("_getDataToBackup");var e={info:t.syncInfo,data:{}};n(e)},_sendDataToServer:function(n,t){var e=this;e.log(n),jQuery.ajax({url:e.serverUrl,type:"POST",data:JSON.stringify(n),dataType:"json",complete:function(n){e.log("Server answered: "),e.log(n)},success:function(n){t(n)},error:function(n){n.result="ERROR",n.message=n.statusText,t(n)}})},_updateLocalDb:function(n,t){var e=this;return n&&"ERROR"!==n.result?"undefined"==typeof n.data||0===n.data.length?void e.db.transaction(function(s){e._finishSync(n.syncDate,s,t(0))}):(AppSyncBeforeUpdate(),void e.db.transaction(function(s){var a=(e.tablesToSync.length,0);e.tablesToSync.forEach(function(t){var c=n.data[t.tableName];"undefined"==typeof c&&(c=[]);var r=c.length;a+=r;var o=0,l=[];for(o=0;r>o;o++)l.push(n.data[t.tableName][o][t.idName]);var i=10,u=e._getAttributesList(n.data[t.tableName][0]),y="SELECT ",f=0,S="",d=!1,h="INSERT OR REPLACE INTO "+t.tableName+" (";h+=e._arrayToString(u,","),h+=") ",S=h,$.each(n.data[t.tableName],function(n,t){S+=y;var a="";for(d=!0,o=0;o<u.length;o++)S+=a+'"'+t[u[o]]+'"',a=",";f+=1,f===i?(e._executeSql(S,null,s),y=" SELECT ",S=h,f=0,d=!1):y=" UNION SELECT "}),d&&e._executeSql(S,null,s)}),e._finishSync(n.syncDate,s,t)})):(e.syncResult.syncOK=!1,e.syncResult.codeStr="syncKoServer",e.syncResult.message=n?n.message:"No answer from the server",void e.cbEndSync(e.syncResult))},_finishSync:function(n,t,e){this.firstSync=!1,this.lastSyncDate=n,this.syncInfo.lastSyncDate=this.lastSyncDate,this._executeSql('UPDATE sync_info SET last_sync = "'+this.lastSyncDate+'"',[],t),AppSyncAfterUpdate(),e()},_selectSql:function(n,t,e){var s=this;s._executeSql(n,[],t,function(n,t){e(s._transformRs(t))},s._errorHandler)},_transformRs:function(n){var t=[];if("undefined"==typeof n.rows)return t;for(var e=0;e<n.rows.length;++e)t.push(n.rows.item(e));return t},_executeSql:function(n,t,e,s){var a=this;a.log("_executeSql: "+n+" with param "+t),s||(s=a._defaultCallBack),e?a._executeSqlBridge(e,n,t,s,a._errorHandler):a.db.transaction(function(e){a._executeSqlBridge(e,n,t,s,a._errorHandler)})},_executeSqlBridge:function(n,t,e,s,a){var c=this;if("undefined"!=typeof c.db.dbPath){var r=[t].concat(e),o=function(t){t.rows.item=function(n){return this[n]},s(n,t)};n.executeSql(r,o,a)}else n.executeSql(t,e,s,a)},_defaultCallBack:function(){},_errorHandler:function(n,t){AppSync.error("Error : "+t.message+" (Code "+t.code+") Transaction.sql = "+n.sql)},_getAttributesList:function(n,t){var e=[];for(var s in n)(!t||"function"!=typeof this[s]||n.hasOwnProperty(s))&&e.push(s);return e},_arrayToString:function(n,t){for(var e="",s=0;s<n.length;s++)e+=n[s],s<n.length-1&&(e+=t);return e}};